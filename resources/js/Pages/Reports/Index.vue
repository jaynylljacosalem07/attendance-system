<script setup>
import AppLayout from "@/Layouts/AppLayout.vue";
import JetButton from "@/Components/PrimaryButton.vue";
import JetModal from "@/Components/DialogModal.vue";
import JetPrimaryButton from "@/Components/PrimaryButton.vue";
import JetSecondaryButton from "@/Components/SecondaryButton.vue";
import JetInputError from "@/Components/InputError.vue";
import JetConfirmModal from "@/Components/ConfirmationModal.vue";
import Multiselect from "@vueform/multiselect";
import { useToast } from "vue-toastification";
import "vue-toastification/dist/index.css";

import moment from "moment";
import { reactive, ref } from "vue";
import { useForm } from "@inertiajs/inertia-vue3";
import exportFromJSON from "export-from-json";

const exportType = exportFromJSON.types.csv;
const fileName = "download";
const toast = useToast({
    position: "bottom-right",
    timeout: 1500,
});

const props = defineProps(["data", "event", "course", "filtered"]);
const form = useForm({
    id: props.event.id,
    year_level: [],
    course: [],
});

const year_levels = reactive([
    { label: "1st Year", value: 1 },
    { label: "2nd Year", value: 2 },
    { label: "3rd Year", value: 3 },
    { label: "4th Year", value: 4 },
]);
const filterReport = () => {
    form.post(route("report.filter", props.event.id), {
        preserveScroll: true,
        preserveState: true,
        onSuccess: () => {
            toast("Record updated.");
            // alert(
            //     `Event successfully ${edit_student.value ? "updated" : "added"}`
            // );
            // if (edit_student.value) edit_student.value = !edit_student.value;
            // show_add_dialog.value = false;
            // form.reset();
        },
        onError: (e) => {
            console.log(e);
        },
    });
};

const downloadReport = () => {
    let obj_data = [];
    if (typeof props.data == "object") {
        let ok = Object.keys(props.data);
        let ov = Object.values(props.data);
        obj_data = ok.map((item, index) => {
            let tmp = {};
            tmp[item] = ov[index];
            return tmp;
        });
    }
    console.log(obj_data);
    //set up data for download
    let fields = ["No.", "Name", "Course", "Year Level"];
    let data = props.data.map((item, index) => {
        // console.log(index, item);
        let in_out = [];
        let info = {
            "No.": index + 1,
            Name: item.user.name,
            Course: item.course.name,
            "Year Level": item.user.year_level,
        };
        item.in.map((time, t_index) => {
            let in_f = {};
            in_f[`In #${t_index + 1}`] = moment(new Date(time)).format("LLLL");
            in_f[`Out #${t_index + 1}`] =
                item.out !== null
                    ? moment(new Date(item.out[t_index])).format("LLLL")
                    : "";
            in_out = { ...in_out, ...in_f };
        });
        // console.log(in_out);
        return { ...info, ...in_out };
    });
    let keys = Object.keys(props.data);
    if (keys.length > 0) {
        let time_in = props.data[keys[0]].in
            .map((item, index) => {
                return [`In #${index + 1}`, `Out #${index + 1}`];
            })
            .join();
        fields = fields.concat(time_in.split(","));
        console.log(fields);
    }
    console.log(data);
    exportFromJSON({ data, fileName, fields, exportType });
};
</script>
<template>
    <AppLayout title="Reports">
        <template #header>
            <div class="accordion" id="accordionExample">
                <div class="accordion-item bg-white border border-gray-200">
                    <h2 class="accordion-header mb-0" id="headingOne">
                        <button
                            class="accordion-button relative flex items-center w-full py-4 px-5 text-base text-gray-800 text-left bg-white border-0 rounded-none transition focus:outline-none"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseOne"
                            aria-expanded="true"
                            aria-controls="collapseOne"
                        >
                            Filter:
                        </button>
                    </h2>
                    <div
                        id="collapseOne"
                        class="accordion-collapse collapse show"
                        aria-labelledby="headingOne"
                        data-bs-parent="#accordionExample"
                    >
                        <div
                            class="block p-6 rounded-lg shadow-lg bg-white max-w-full"
                        >
                            <div class="form-group mb-6">
                                <label
                                    for="exampleInputEmail1"
                                    class="form-label inline-block mb-2 text-gray-700"
                                    >Filter By:</label
                                >

                                <multiselect
                                    class="form-control block w-full px-3 py-1.5 text-base font-normal text-gray-700 bg-white bg-clip-padding border border-solid border-gray-300 rounded transition ease-in-out m-0 focus:text-gray-700 focus:bg-white focus:border-blue-600 focus:outline-none"
                                    placeholder="Course"
                                    mode="tags"
                                    :options="
                                        course.map((o) => {
                                            return {
                                                label: o.name,
                                                value: o.id,
                                            };
                                        })
                                    "
                                    v-model="form.course"
                                ></multiselect>
                            </div>
                            <div class="form-group mb-6">
                                <multiselect
                                    class="form-control block w-full px-3 py-1.5 text-base font-normal text-gray-700 bg-white bg-clip-padding border border-solid border-gray-300 rounded transition ease-in-out m-0 focus:text-gray-700 focus:bg-white focus:border-blue-600 focus:outline-none"
                                    placeholder=" Level"
                                    mode="tags"
                                    :options="year_levels"
                                    v-model="form.year_level"
                                ></multiselect>
                            </div>
                            <div class="flex space-x-2">
                                <div>
                                    <button
                                        class="mr-1 inline-block px-6 py-2.5 bg-blue-600 text-white font-medium text-xs leading-tight uppercase rounded shadow-md hover:bg-blue-700 hover:shadow-lg focus:bg-blue-700 focus:shadow-lg focus:outline-none focus:ring-0 active:bg-blue-800 active:shadow-lg transition duration-150 ease-in-out"
                                        @click="filterReport"
                                    >
                                        Filter
                                    </button>

                                    <button
                                        class="inline-block px-6 py-2.5 bg-blue-600 text-white font-medium text-xs leading-tight uppercase rounded shadow-md hover:bg-blue-700 hover:shadow-lg focus:bg-blue-700 focus:shadow-lg focus:outline-none focus:ring-0 active:bg-blue-800 active:shadow-lg transition duration-150 ease-in-out"
                                        @click="downloadReport"
                                    >
                                        Download
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        <div class="py-12 mb-5 mx-28">
            <div class="mt-1 overflow-hidden bg-white mb-2">
                <div class="c overflow-auto">
                    <table class="min-w-full">
                        <thead class="bg-white border-b">
                            <tr>
                                <th
                                    scope="col"
                                    class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                                >
                                    No.
                                </th>
                                <th
                                    scope="col"
                                    class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                                >
                                    Name
                                </th>
                                <th
                                    scope="col"
                                    class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                                >
                                    Course
                                </th>
                                <th
                                    scope="col"
                                    class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                                >
                                    Year Level
                                </th>
                                <template
                                    v-for="(st, st_index) in event.start_time"
                                    :key="st_index"
                                >
                                    <th
                                        scope="col"
                                        class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                                    >
                                        In #{{ st_index + 1 }}
                                    </th>

                                    <th
                                        scope="col"
                                        class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                                    >
                                        Out #{{ st_index + 1 }}
                                    </th>
                                </template>
                            </tr>
                        </thead>
                        <tbody>
                            <tr
                                v-for="(d, index) in data"
                                :key="index"
                                class="border-b bg-white"
                            >
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                >
                                    {{ index + 1 }}
                                </td>
                                <td
                                    class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                                >
                                    {{ d.user.name }}
                                </td>
                                <td
                                    class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                                >
                                    {{ d.course.name }}
                                </td>
                                <td
                                    class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                                >
                                    {{
                                        year_levels.find((o) => {
                                            return o.value == d.year_level_id;
                                        }).label
                                    }}
                                </td>
                                <template
                                    v-for="(st, st_index) in d?.in"
                                    :key="st_index"
                                >
                                    <td
                                        class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                                    >
                                        {{
                                            moment(new Date(st)).format("LLLL")
                                        }}
                                    </td>
                                    <td
                                        class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                                        v-if="d?.out"
                                    >
                                        {{
                                            moment(
                                                new Date(d?.out[st_index])
                                            ).format("LLLL")
                                        }}
                                    </td>
                                </template>
                            </tr>
                            <tr>
                                <td
                                    v-if="data.length === 0"
                                    colspan="5"
                                    class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                                >
                                    No result found
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </AppLayout>
    <JetModal
        :show="show_add_dialog"
        @close="show_add_dialog = false"
        maxWidth="2xl"
    >
        <template #title>Add Event</template>
        <template #content>
            <div class="shadow sm:rounded-md sm:rounded-md">
                <div class="space-y-6 bg-white px-4 py-5 sm:p-6">
                    <div>
                        <label
                            for="name"
                            class="block text-sm font-medium text-gray-700"
                            >Event Name</label
                        >
                        <input
                            v-model="form.name"
                            type="text"
                            name="name"
                            id="name"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                        />
                        <JetInputError
                            :message="form.errors.addStudents?.name"
                            class="mt-2"
                        />
                    </div>

                    <div>
                        <label
                            for="start"
                            class="block text-sm font-medium text-gray-700"
                            >Time in</label
                        >
                        <input
                            type="datetime-local"
                            name="start"
                            id="start"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                            v-model="form.start_date"
                        />
                        <button
                            @click="form.start_time.push(form.start_date)"
                            class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-1 px-3 mt-1 mb-1 text-sm font-small text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                        >
                            Add
                        </button>
                        <button
                            @click="removeTime('start_time')"
                            class="ml-1 inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-1 px-3 mt-1 mb-1 text-sm font-small text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                        >
                            Delete
                        </button>
                        <div class="space-y-6 bg-white px-4 py-5 sm:p-6">
                            <div>
                                <h3 class="text-base font-medium text-gray-500">
                                    Time in
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <div
                                        v-for="(
                                            ti, ti_index
                                        ) in form.start_time"
                                        :key="ti_index"
                                        class="flex items-start"
                                    >
                                        <div class="flex h-5 items-center">
                                            <input
                                                v-model="
                                                    delete_entries.in[ti_index]
                                                "
                                                id="start_date"
                                                name="start_date"
                                                type="checkbox"
                                                class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                            />
                                        </div>
                                        <div class="ml-3 text-sm">
                                            <label
                                                for="comments"
                                                class="font-medium text-gray-700"
                                            >
                                                {{
                                                    moment(new Date(ti)).format(
                                                        "LLLL"
                                                    )
                                                }}</label
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <JetInputError
                            :message="form.errors.addStudents?.start_time"
                            class="mt-2"
                        />
                    </div>
                    <div>
                        <label
                            for="end"
                            class="block text-sm font-medium text-gray-700"
                            >Time out</label
                        >
                        <input
                            type="datetime-local"
                            name="end"
                            id="end"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                            v-model="form.end_date"
                        />
                        <button
                            @click="form.end_time.push(form.end_date)"
                            class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-1 px-3 mt-1 mb-1 text-sm font-small text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                        >
                            Add
                        </button>
                        <button
                            @click="removeTime('end_time')"
                            class="ml-1 inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-1 px-3 mt-1 mb-1 text-sm font-small text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                        >
                            Delete
                        </button>
                        <div class="space-y-6 bg-white px-4 py-5 sm:p-6">
                            <div>
                                <h3 class="text-base font-medium text-gray-500">
                                    Time out
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <div
                                        v-for="(ti, ti_index) in form.end_time"
                                        :key="ti_index"
                                        class="flex items-start"
                                    >
                                        <div class="flex h-5 items-center">
                                            <input
                                                v-model="
                                                    delete_entries.out[ti_index]
                                                "
                                                id="end_time"
                                                name="end_time"
                                                type="checkbox"
                                                class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                            />
                                        </div>
                                        <div class="ml-3 text-sm">
                                            <label
                                                for="comments"
                                                class="font-medium text-gray-700"
                                            >
                                                {{
                                                    moment(new Date(ti)).format(
                                                        "LLLL"
                                                    )
                                                }}</label
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <JetInputError
                            :message="form.errors.addStudents?.end_time"
                            class="mt-2"
                        />
                    </div>
                    <div>
                        <label
                            for="course"
                            class="block text-sm font-medium text-gray-700"
                            >Course</label
                        >
                        <multiselect
                            mode="tags"
                            v-model="form.course"
                            :options="
                                course.map((o) => {
                                    return { label: o.name, value: o.id };
                                })
                            "
                        ></multiselect>

                        <!-- <select
                            v-model="form.year_levels"
                            name="year_levels"
                            id="year_levels"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                        >
                            <option selected value="0">All</option>
                            <option value="1">1st Year</option>
                            <option value="2">2nd Year</option>
                            <option value="3">3rd Year</option>
                            <option value="4">4th Year</option>
                        </select> -->
                        <JetInputError
                            :message="form.errors.addStudents?.year_levels"
                            class="mt-2"
                        />
                    </div>
                    <div>
                        <label
                            for="year_levels"
                            class="block text-sm font-medium text-gray-700"
                            >Year Level</label
                        >
                        <multiselect
                            mode="tags"
                            :close-on-select="false"
                            v-model="form.year_level"
                            :options="year_levels"
                        ></multiselect>

                        <!-- <select
                            v-model="form.year_levels"
                            name="year_levels"
                            id="year_levels"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                        >
                            <option selected value="0">All</option>
                            <option value="1">1st Year</option>
                            <option value="2">2nd Year</option>
                            <option value="3">3rd Year</option>
                            <option value="4">4th Year</option>
                        </select> -->
                        <JetInputError
                            :message="form.errors.addStudents?.year_levels"
                            class="mt-2"
                        />
                    </div>
                </div></div
        ></template>
        <template #footer>
            <JetSecondaryButton @click="show_add_dialog = false" class="mr-2">
                Cancel
            </JetSecondaryButton>
            <JetPrimaryButton
                :class="{ 'opacity-25': form?.processing }"
                :disabled="form?.processing"
                @click="addStudent"
                >{{ edit_student ? "Update" : "Add" }}
            </JetPrimaryButton></template
        >
    </JetModal>
    <JetConfirmModal :show="confirm_delete" @close="showConfirmModal = false">
        <template #title>Confirm Close</template>
        <template #content>Are you sure you want to close this event?</template>
        <template #footer>
            <JetSecondaryButton @click="confirm_delete = false"
                >Cancel</JetSecondaryButton
            >
            <JetPrimaryButton @click="confirmDelete">Confirm</JetPrimaryButton>
        </template>
    </JetConfirmModal>
</template>
<style src="@vueform/multiselect/themes/default.css"></style>
